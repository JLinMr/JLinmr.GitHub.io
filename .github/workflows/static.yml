name: Deploy static content to GitHub Pages and OSS

# 触发条件：当主分支有推送时触发
on:
  push:
    branches: ["main"]

# 设置 GITHUB_TOKEN 的权限
permissions:
  contents: read  # 允许读取仓库内容
  pages: write   # 允许写入 GitHub Pages
  id-token: write  # 允许写入 ID 令牌

# 并发控制：只允许一个部署任务运行，不取消正在进行的任务
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 部署到 GitHub Pages 的任务
  deploy-pages:
    runs-on: ubuntu-latest  # 运行在最新的 Ubuntu 环境
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # 检出代码库

      - name: Setup Pages
        uses: actions/configure-pages@v5
        # 配置 GitHub Pages

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
        # 上传构建的静态文件到 GitHub Pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # 部署到 GitHub Pages

  # 上传到阿里云 OSS 的任务
  upload-oss:
    runs-on: ubuntu-latest  # 运行在最新的 Ubuntu 环境
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # 检出代码库

      - name: Setup Aliyun CLI
        uses: aliyun/setup-aliyun-cli-action@v1
        with:
          access-key-id: ${{ secrets.OSS_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          region: ${{ secrets.OSS_REGION }}
        # 设置阿里云 CLI

      - name: Upload to OSS
        run: |
          aliyun oss cp --recursive . oss://${{ secrets.OSS_BUCKET_NAME }}/
        # 使用阿里云 CLI 上传文件到阿里云 OSS
        # 需要设置以下 Secrets：
        # OSS_ACCESS_KEY_ID: OSS 访问密钥 ID
        # OSS_ACCESS_KEY_SECRET: OSS 访问密钥 Secret
        # OSS_REGION: OSS 区域
        # OSS_BUCKET_NAME: OSS 存储桶名称
